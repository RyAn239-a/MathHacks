<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Epidemic Simulation</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles.css') }}"
    />
  </head>
  <body>
    <header class="header-container">
      <a href="{{ url_for('home') }}" class="btn" id="home">Back to Home</a>
      <h1>Epidemic Spread Simulation</h1>
      <button class="bton" id="openModal">Ë…</button>
      <div class="modal" id="descriptionModal">
        <div class="modal-content">
          <button class="close-btn" id="closeModal">&times;</button>
          <h2>Epidemic Spread Simulation</h2>
          <p>
            Simulate your own infection spread! Adjust parameters like population size, infection probability, and 
            recovery probability to see how they affect the dynamics of an epidemic. Orange dots represent susceptible individuals, 
            red dots represent infected individuals, and over time infected individuals will recover and turn back to orange. 
          </p>
        </div>
      </div>
    </header>
    <div class="main-layout">
      <form id="specs" method="post">
        <label
          >Population: <input type="number" name="population_size" value="500"
        /></label>
        <label
          >Initially Infected:
          <input type="number" name="initial_infected" value="5"
        /></label>
        <label
          >Infection Probability:
          <input type="number" name="infection_prob" step="0.01" value="0.05"
        /></label>
        <label
          >Recovery Probability:
          <input type="number" name="recovery_prob" step="0.01" value="0.05"
        /></label>
        <label
          >Time Steps: <input type="number" name="time_steps" value="50"
        /></label>
        <label
          >Grid Size: <input type="number" name="grid_size" value="20"
        /></label>
        <label
          >Infection Radius:
          <input type="number" name="infection_radius" step="0.1" value="1.5"
        /></label>
        <button class="start" type="submit">Run Simulation</button>
      </form>
      <div class="canvas-container">
        <canvas id="simulationCanvas" width="500" height="500"></canvas>
      </div>
    </div>

    <script>
      // popup logic
      const openBtn = document.getElementById("openModal");
      const modal = document.getElementById("descriptionModal");
      const closeBtn = document.getElementById("closeModal");

      openBtn.addEventListener("click", () => {
        modal.style.display = "flex"; // show modal with flex to center content
      });

      closeBtn.addEventListener("click", () => {
        modal.style.display = "none"; // hide modal
      });

      // Close modal if user clicks outside the content box
      window.addEventListener("click", (e) => {
        if (e.target === modal) {
          modal.style.display = "none";
        }
      });

      // Simulation Visualization
      const canvas = document.getElementById('simulationCanvas');
      const ctx = canvas.getContext('2d');

      {% if history %}
      const historyData = {{ history | tojson }};
      const gridSize = {{ grid_size }};
      const cellSize = canvas.width / gridSize;

      let step = 0;
      const interval = setInterval(() => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          const current = historyData[step];

          current.forEach(person => {
              let color = '#ea7b49'; // Susceptible
              if(person.state === 'I') color = '#f5566a'; // Infected
              if(person.state === 'R') color = '#ea7b49'; // Recovered

              ctx.beginPath();
              ctx.arc(
                  (person.x + 0.5) * cellSize,
                  (person.y + 0.5) * cellSize,
                  cellSize / 2.5,
                  0, Math.PI*2
              );
              ctx.fillStyle = color;
              ctx.fill();
          });

          step++;
          if(step >= historyData.length) clearInterval(interval);
      }, 200);
      {% endif %}
    </script>
  </body>
</html>
